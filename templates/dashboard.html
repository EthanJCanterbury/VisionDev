{% extends "base.html" %} {% block content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
    <div class="mb-8">
        <h1 class="text-3xl font-bold text-gray-900">
            <i class="fas fa-database mr-2 text-blue-500"></i>
            Airtable Bases
        </h1>
        <p class="mt-2 text-sm text-gray-600">
            Manage your connected Airtable bases and tables
        </p>
    </div>

    <!-- Add Base Form -->
    <div class="bg-white rounded-lg shadow-md p-6 mb-8">
        <h2 class="text-xl font-semibold mb-4 text-gray-900">
            <i class="fas fa-plus-circle mr-2 text-green-500"></i>
            Add New Base
        </h2>
        <form id="addBaseForm" class="space-y-4">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">
                        <i class="fas fa-database mr-1"></i> Base ID
                    </label>
                    <input
                        type="text"
                        id="base_id"
                        required
                        placeholder="app3A5kJwYqxMLOgh"
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                    />
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">
                        <i class="fas fa-table mr-1"></i> Table Name
                    </label>
                    <input
                        type="text"
                        id="table_name"
                        required
                        placeholder="Projects"
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                    />
                </div>
            </div>
            <button
                type="submit"
                class="w-full md:w-auto px-6 py-2 bg-blue-600 text-white font-medium rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500"
            >
                <i class="fas fa-scan mr-2"></i>
                Scan & Add Base
            </button>
        </form>
        <div id="addBaseResult" class="mt-4 hidden"></div>
    </div>

    <!-- Connected Bases List -->
    <div class="bg-white rounded-lg shadow-md overflow-hidden">
        <div class="px-6 py-4 border-b border-gray-200">
            <h2 class="text-xl font-semibold text-gray-900">
                <i class="fas fa-link mr-2 text-blue-500"></i>
                Connected Bases
            </h2>
        </div>
        <div class="divide-y divide-gray-200">
            {% if bases %} {% for base in bases %}
            <div class="p-6 hover:bg-gray-50">
                <div class="flex items-center justify-between">
                    <div class="flex-1">
                        <h3 class="text-lg font-medium text-gray-900">
                            <i class="fas fa-table mr-2 text-gray-400"></i>
                            {{ base.table_name }}
                        </h3>
                        <p class="text-sm text-gray-500 mt-1">
                            <i class="fas fa-key mr-1"></i>
                            Base ID:
                            <code class="bg-gray-100 px-2 py-1 rounded"
                                >{{ base.base_id }}</code
                            >
                        </p>
                        <p class="text-xs text-gray-400 mt-1">
                            DB ID: {{ base.id }} | User: {{ base.user_id }}
                        </p>
                        <div class="mt-3">
                            <details class="text-sm">
                                <summary
                                    class="cursor-pointer text-blue-600 hover:text-blue-700"
                                >
                                    <i class="fas fa-list mr-1"></i>
                                    View Field Mappings & Additional Settings
                                </summary>
                                <div
                                    class="mt-2 bg-gray-50 p-3 rounded border border-gray-200"
                                >
                                    {% set mappings = base.field_mappings |
                                    fromjson %}
                                    <div
                                        id="mappings-view-{{ base.id }}"
                                        class="space-y-3"
                                    >
                                        <div class="flex items-start gap-2">
                                            <i class="fas fa-github text-blue-500 mt-0.5"></i>
                                            <div class="flex-1">
                                                <div class="flex items-center gap-2 mb-1">
                                                    <strong class="text-xs">Code URL</strong>
                                                    <span class="px-2 py-0.5 bg-blue-100 text-blue-700 text-[10px] font-bold rounded">URL</span>
                                                </div>
                                                <span class="text-xs {{ 'text-gray-600' if mappings.code_url != 'null' else 'text-red-500 font-semibold' }}">
                                                    {{ mappings.code_url if mappings.code_url != 'null' else '⚠️ Missing' }}
                                                </span>
                                            </div>
                                        </div>
                                        <div class="flex items-start gap-2">
                                            <i class="fas fa-globe text-green-500 mt-0.5"></i>
                                            <div class="flex-1">
                                                <div class="flex items-center gap-2 mb-1">
                                                    <strong class="text-xs">Playable URL</strong>
                                                    <span class="px-2 py-0.5 bg-blue-100 text-blue-700 text-[10px] font-bold rounded">URL</span>
                                                </div>
                                                <span class="text-xs {{ 'text-gray-600' if mappings.playable_url != 'null' else 'text-red-500 font-semibold' }}">
                                                    {{ mappings.playable_url if mappings.playable_url != 'null' else '⚠️ Missing' }}
                                                </span>
                                            </div>
                                        </div>
                                        <div class="flex items-start gap-2">
                                            <i class="fas fa-clock text-orange-500 mt-0.5"></i>
                                            <div class="flex-1">
                                                <div class="flex items-center gap-2 mb-1">
                                                    <strong class="text-xs">Hackatime Hours</strong>
                                                    <span class="px-2 py-0.5 bg-orange-100 text-orange-700 text-[10px] font-bold rounded">Number</span>
                                                </div>
                                                <span class="text-xs {{ 'text-gray-600' if mappings.hackatime_hours != 'null' else 'text-red-500 font-semibold' }}">
                                                    {{ mappings.hackatime_hours if mappings.hackatime_hours != 'null' else '⚠️ Missing' }}
                                                </span>
                                            </div>
                                        </div>
                                        <div class="flex items-start gap-2">
                                            <i class="fas fa-sticky-note text-purple-500 mt-0.5"></i>
                                            <div class="flex-1">
                                                <div class="flex items-center gap-2 mb-1">
                                                    <strong class="text-xs">Auto Review Notes</strong>
                                                    <span class="px-2 py-0.5 bg-purple-100 text-purple-700 text-[10px] font-bold rounded">Long text</span>
                                                </div>
                                                <span class="text-xs {{ 'text-gray-600' if mappings.auto_review_notes != 'null' else 'text-red-500 font-semibold' }}">
                                                    {{ mappings.auto_review_notes if mappings.auto_review_notes != 'null' else '⚠️ Missing' }}
                                                </span>
                                            </div>
                                        </div>
                                        <div class="flex items-start gap-2">
                                            <i class="fas fa-comment-dots text-teal-500 mt-0.5"></i>
                                            <div class="flex-1">
                                                <div class="flex items-center gap-2 mb-1">
                                                    <strong class="text-xs">Auto User Feedback</strong>
                                                    <span class="px-2 py-0.5 bg-purple-100 text-purple-700 text-[10px] font-bold rounded">Long text</span>
                                                </div>
                                                <span class="text-xs {{ 'text-gray-600' if mappings.auto_user_feedback != 'null' else 'text-red-500 font-semibold' }}">
                                                    {{ mappings.auto_user_feedback if mappings.auto_user_feedback != 'null' else '⚠️ Missing' }}
                                                </span>
                                            </div>
                                        </div>
                                        <div class="flex items-start gap-2">
                                            <i class="fas fa-tag text-pink-500 mt-0.5"></i>
                                            <div class="flex-1">
                                                <div class="flex items-center gap-2 mb-1">
                                                    <strong class="text-xs">Auto Review Tag</strong>
                                                    <span class="px-2 py-0.5 bg-pink-100 text-pink-700 text-[10px] font-bold rounded">Single select</span>
                                                    <span class="text-[10px] text-gray-500">(Approved/Flagged/Error)</span>
                                                </div>
                                                <span class="text-xs {{ 'text-gray-600' if mappings.auto_review_tag != 'null' else 'text-red-500 font-semibold' }}">
                                                    {{ mappings.auto_review_tag if mappings.auto_review_tag != 'null' else '⚠️ Missing' }}
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                    <div
                                        id="mappings-edit-{{ base.id }}"
                                        class="space-y-2 hidden"
                                    >
                                        <div class="text-xs">
                                            <label class="font-medium"
                                                >Code URL:</label
                                            >
                                            <input
                                                type="text"
                                                class="w-full px-2 py-1 text-xs border rounded"
                                                data-field="code_url"
                                                value="{{ mappings.code_url if mappings.code_url != 'null' else '' }}"
                                            />
                                        </div>
                                        <div class="text-xs">
                                            <label class="font-medium"
                                                >Playable URL:</label
                                            >
                                            <input
                                                type="text"
                                                class="w-full px-2 py-1 text-xs border rounded"
                                                data-field="playable_url"
                                                value="{{ mappings.playable_url if mappings.playable_url != 'null' else '' }}"
                                            />
                                        </div>
                                        <div class="text-xs">
                                            <label class="font-medium"
                                                >Hackatime Hours:</label
                                            >
                                            <input
                                                type="text"
                                                class="w-full px-2 py-1 text-xs border rounded"
                                                data-field="hackatime_hours"
                                                value="{{ mappings.hackatime_hours if mappings.hackatime_hours != 'null' else '' }}"
                                            />
                                        </div>
                                        <div class="text-xs">
                                            <label class="font-medium"
                                                >Auto Review Notes:</label
                                            >
                                            <input
                                                type="text"
                                                class="w-full px-2 py-1 text-xs border rounded"
                                                data-field="auto_review_notes"
                                                value="{{ mappings.auto_review_notes if mappings.auto_review_notes != 'null' else '' }}"
                                            />
                                        </div>
                                        <div class="text-xs">
                                            <label class="font-medium"
                                                >Auto User Feedback:</label
                                            >
                                            <input
                                                type="text"
                                                class="w-full px-2 py-1 text-xs border rounded"
                                                data-field="auto_user_feedback"
                                                value="{{ mappings.auto_user_feedback if mappings.auto_user_feedback != 'null' else '' }}"
                                            />
                                        </div>
                                        <div class="text-xs">
                                            <label class="font-medium"
                                                >Auto Review Tag:</label
                                            >
                                            <input
                                                type="text"
                                                class="w-full px-2 py-1 text-xs border rounded"
                                                data-field="auto_review_tag"
                                                value="{{ mappings.auto_review_tag if mappings.auto_review_tag != 'null' else '' }}"
                                            />
                                        </div>
                                    </div>
                                    <div class="mt-3 space-y-2">
                                        <div
                                            id="edit-actions-{{ base.id }}"
                                            class="flex gap-2"
                                        >
                                            <button
                                                onclick="toggleEditMode({{ base.id }})"
                                                class="flex-1 px-3 py-2 bg-blue-600 text-white text-sm rounded-lg hover:bg-blue-700 transition-all"
                                            >
                                                <i class="fas fa-edit mr-2"></i>
                                                <span
                                                    id="edit-btn-text-{{ base.id }}"
                                                    >Edit</span
                                                >
                                            </button>
                                            <button
                                                data-airtable-base="{{ base.base_id }}"
                                                data-table-name="{{ base.table_name }}"
                                                data-db-id="{{ base.id }}"
                                                onclick="rescanFieldMappings(this.dataset)"
                                                class="flex-1 px-3 py-2 bg-purple-600 text-white text-sm rounded-lg hover:bg-purple-700 transition-all"
                                            >
                                                <i
                                                    class="fas fa-sync-alt mr-2"
                                                ></i>
                                                Re-scan
                                            </button>
                                        </div>
                                        <button
                                            data-db-id="{{ base.id }}"
                                            data-custom-instructions="{{ base.custom_instructions or '' }}"
                                            onclick="openCustomInstructions(this.dataset)"
                                            class="w-full px-3 py-2 bg-green-600 text-white text-sm rounded-lg hover:bg-green-700 transition-all"
                                        >
                                            <i
                                                class="fas fa-clipboard-list mr-2"
                                            ></i>
                                            {% if base.custom_instructions %}
                                            Edit Custom Instructions {% else %}
                                            Add Custom Instructions {% endif %}
                                        </button>
                                        <button
                                            id="save-mappings-{{ base.id }}"
                                            data-airtable-base="{{ base.base_id }}"
                                            data-table-name="{{ base.table_name }}"
                                            onclick="saveInlineMappings({{ base.id }}, this.dataset)"
                                            class="hidden w-full px-3 py-2 bg-green-600 text-white text-sm rounded-lg hover:bg-green-700 transition-all"
                                        >
                                            <i class="fas fa-save mr-2"></i>
                                            Save Changes
                                        </button>
                                    </div>
                                </div>
                            </details>
                        </div>
                    </div>
                    <div class="ml-4 flex flex-col space-y-2">
                        <button
                            onclick="startReviewPrompt('{{ base.base_id }}', '{{ base.table_name }}')"
                            class="px-4 py-2 bg-green-600 text-white font-medium rounded-lg hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 transition-all"
                        >
                            <i class="fas fa-play mr-2"></i>
                            Start Review
                        </button>
                        <button
                            data-base-id="{{ base.id | string }}"
                            data-table-name="{{ base.table_name }}"
                            onclick="confirmDeleteBase(this.dataset.baseId, this.dataset.tableName)"
                            class="px-4 py-2 bg-red-600 text-white font-medium rounded-lg hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 transition-all"
                        >
                            <i class="fas fa-trash mr-2"></i>
                            Delete
                        </button>
                    </div>
                </div>
            </div>
            {% endfor %} {% else %}
            <div class="p-8 text-center text-gray-500">
                <i class="fas fa-inbox text-4xl mb-3"></i>
                <p>No bases connected yet. Add your first base above!</p>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Review Modal -->
<div
    id="reviewModal"
    class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50 transition-opacity duration-300"
>
    <div
        class="relative top-10 mx-auto p-6 border w-full max-w-3xl shadow-lg rounded-lg bg-white transform transition-all duration-300 scale-95"
        id="reviewModalContent"
    >
        <div class="mt-3">
            <h3 class="text-xl font-semibold text-gray-900 mb-4">
                <i class="fas fa-clipboard-check mr-2 text-blue-500"></i>
                Select Record to Review
            </h3>

            <!-- Bulk Mode Toggle -->
            <div class="mb-4 flex items-center justify-between">
                <label class="flex items-center cursor-pointer">
                    <input
                        type="checkbox"
                        id="bulkModeToggle"
                        onchange="toggleBulkMode()"
                        class="mr-2"
                    />
                    <span class="text-sm font-medium text-gray-700">
                        <i class="fas fa-tasks mr-1"></i>
                        Bulk Selection Mode
                    </span>
                </label>
                <span id="selectedCount" class="text-sm text-gray-600 hidden">
                    <i class="fas fa-check-circle mr-1 text-green-600"></i>
                    <span id="selectedCountNum">0</span> selected
                </span>
            </div>

            <!-- Search Input -->
            <div class="mb-4">
                <div class="relative">
                    <input
                        type="text"
                        id="record_search"
                        placeholder="Search records..."
                        oninput="searchRecords()"
                        class="w-full px-4 py-2 pl-10 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                    />
                    <i
                        class="fas fa-search absolute left-3 top-3 text-gray-400"
                    ></i>
                </div>
            </div>

            <!-- Results -->
            <div
                id="record_results"
                class="mb-4 max-h-96 overflow-y-auto border border-gray-200 rounded-lg"
            >
                <div class="p-8 text-center text-gray-500">
                    <i class="fas fa-search text-4xl mb-3"></i>
                    <p>Search for records to review</p>
                </div>
            </div>

            <!-- Actions -->
            <div class="flex space-x-3">
                <button
                    onclick="startReviewWithSelected()"
                    id="startReviewBtn"
                    disabled
                    class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-all disabled:bg-gray-400 disabled:cursor-not-allowed"
                >
                    <i class="fas fa-check mr-2"></i>
                    <span id="startReviewBtnText">Start Review</span>
                </button>
                <button
                    onclick="closeReviewModal()"
                    class="flex-1 px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition-all"
                >
                    <i class="fas fa-times mr-2"></i>
                    Cancel
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div
    id="deleteModal"
    class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50 transition-opacity duration-300"
>
    <div
        class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-lg bg-white transform transition-all duration-300"
    >
        <div class="mt-3">
            <div
                class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100"
            >
                <i
                    class="fas fa-exclamation-triangle text-red-600 text-2xl"
                ></i>
            </div>
            <h3 class="text-lg font-medium text-gray-900 mt-4 text-center">
                Delete Base?
            </h3>
            <p
                class="text-sm text-gray-500 mt-2 text-center"
                id="deleteBaseInfo"
            ></p>
            <div class="flex space-x-3 mt-6">
                <button
                    onclick="deleteBase()"
                    class="flex-1 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-all"
                >
                    <i class="fas fa-trash mr-2"></i>
                    Delete
                </button>
                <button
                    onclick="closeDeleteModal()"
                    class="flex-1 px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition-all"
                >
                    <i class="fas fa-times mr-2"></i>
                    Cancel
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Missing Fields Confirmation Modal -->
<div
    id="missingFieldsConfirmModal"
    class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50 transition-opacity duration-300"
>
    <div
        class="relative top-20 mx-auto p-6 border w-full max-w-md shadow-lg rounded-lg bg-white transform transition-all duration-300"
    >
        <div class="mt-3">
            <div
                class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-orange-100"
            >
                <i
                    class="fas fa-exclamation-triangle text-orange-600 text-2xl"
                ></i>
            </div>
            <h3 class="text-lg font-medium text-gray-900 mt-4 text-center">
                Missing Fields Detected
            </h3>
            <div
                class="mt-4 bg-orange-50 border border-orange-200 rounded-lg p-4"
            >
                <p class="text-sm text-gray-700 mb-2">
                    <i class="fas fa-check-circle text-green-600 mr-2"></i>
                    Base added successfully!
                </p>
                <p class="text-sm text-gray-600 mb-2">
                    The following fields could not be detected:
                </p>
                <ul
                    id="missingFieldsList"
                    class="text-sm text-orange-700 list-disc list-inside space-y-1"
                ></ul>
            </div>
            <p class="text-sm text-gray-600 mt-4 text-center">
                Would you like to add these fields now?
            </p>
            <div class="flex space-x-3 mt-6">
                <button
                    onclick="proceedToAddFields()"
                    class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-all"
                >
                    <i class="fas fa-plus-circle mr-2"></i>
                    Yes, Add Fields
                </button>
                <button
                    onclick="skipAddingFields()"
                    class="flex-1 px-4 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition-all"
                >
                    <i class="fas fa-times mr-2"></i>
                    Skip for Now
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Missing Fields Modal (kept for initial setup) -->
<div
    id="fieldModal"
    class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50 transition-opacity duration-300"
>
    <div
        class="relative top-10 mx-auto p-6 border w-full max-w-4xl shadow-lg rounded-lg bg-white transform transition-all duration-300 max-h-[90vh] overflow-y-auto"
    >
        <div class="mt-3">
            <h3 class="text-2xl font-bold text-gray-900 mb-4">
                <i class="fas fa-magic mr-2 text-purple-600"></i>
                Create Required Airtable Fields
            </h3>
            <p class="text-sm text-gray-700 mb-4">
                Follow these step-by-step instructions to create the required fields in your Airtable base.
            </p>

            <div class="bg-gradient-to-r from-blue-50 to-purple-50 border-2 border-blue-300 rounded-lg p-5 mb-6">
                <h4 class="font-bold text-blue-900 mb-3 text-lg">
                    <i class="fas fa-route mr-2"></i>
                    Quick Setup Guide
                </h4>
                <ol class="text-sm text-blue-900 space-y-2 list-decimal list-inside">
                    <li class="font-medium">Open your Airtable base in a new tab</li>
                    <li class="font-medium">For each field below, click the <kbd class="px-2 py-1 bg-white rounded border">+</kbd> button to add a new field</li>
                    <li class="font-medium">Match the field type and configuration exactly as shown</li>
                    <li class="font-medium">Enter the field names you created in the boxes below</li>
                    <li class="font-medium">Click "Save Mappings" when done</li>
                </ol>
            </div>

            <div id="fieldInputs" class="space-y-5"></div>

            <div class="flex space-x-3 mt-6">
                <button
                    onclick="updateFieldMappings()"
                    class="flex-1 px-6 py-3 bg-gradient-to-r from-blue-600 to-purple-600 text-white font-bold rounded-lg hover:from-blue-700 hover:to-purple-700 transition-all shadow-lg"
                >
                    <i class="fas fa-save mr-2"></i>
                    Save Mappings
                </button>
                <button
                    onclick="closeFieldModal()"
                    class="px-6 py-3 bg-gray-300 text-gray-700 font-medium rounded-lg hover:bg-gray-400 transition-all"
                >
                    <i class="fas fa-times mr-2"></i>
                    Cancel
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Loading Modal -->
<div
    id="loadingModal"
    class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50"
>
    <div
        class="bg-white rounded-2xl p-8 max-w-md w-full mx-4 shadow-2xl transform transition-all"
    >
        <div class="text-center">
            <!-- Animated spinner -->
            <div class="relative mx-auto w-20 h-20 mb-6">
                <div
                    class="absolute top-0 left-0 w-full h-full border-4 border-blue-200 rounded-full"
                ></div>
                <div
                    class="absolute top-0 left-0 w-full h-full border-4 border-blue-600 rounded-full border-t-transparent animate-spin"
                ></div>
                <div
                    class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2"
                >
                    <i
                        class="fas fa-brain text-blue-600 text-2xl animate-pulse"
                    ></i>
                </div>
            </div>

            <!-- Loading text -->
            <h3
                class="text-xl font-semibold text-gray-900 mb-2"
                id="loadingTitle"
            >
                Processing...
            </h3>
            <p class="text-gray-600 mb-4" id="loadingMessage">
                Please wait while we process your request
            </p>

            <!-- Progress dots -->
            <div class="flex justify-center space-x-2">
                <div
                    class="w-3 h-3 bg-blue-600 rounded-full animate-bounce"
                    style="animation-delay: 0ms"
                ></div>
                <div
                    class="w-3 h-3 bg-blue-600 rounded-full animate-bounce"
                    style="animation-delay: 150ms"
                ></div>
                <div
                    class="w-3 h-3 bg-blue-600 rounded-full animate-bounce"
                    style="animation-delay: 300ms"
                ></div>
            </div>
        </div>
    </div>
</div>

<style>
    @keyframes fadeIn {
        from {
            opacity: 0;
        }
        to {
            opacity: 1;
        }
    }

    @keyframes slideUp {
        from {
            transform: translateY(20px);
            opacity: 0;
        }
        to {
            transform: translateY(0);
            opacity: 1;
        }
    }

    .modal-show {
        animation: fadeIn 0.3s ease-out;
    }

    .modal-content-show {
        animation: slideUp 0.3s ease-out;
    }
</style>

<script>
    let currentBaseId, currentTableName;

    // Check if we need to show field modal after page load
    window.addEventListener("DOMContentLoaded", () => {
        const modalData = sessionStorage.getItem("showFieldModal");
        if (modalData) {
            sessionStorage.removeItem("showFieldModal");
            const data = JSON.parse(modalData);

            // Wait for DOM to be ready
            setTimeout(() => {
                showFieldModalDirect(
                    data.baseId,
                    data.airtableBase,
                    data.tableName,
                    data.missingFields,
                );
            }, 500);
        }
    });

    function showLoadingModal(title, message) {
        const modal = document.getElementById("loadingModal");
        document.getElementById("loadingTitle").textContent = title;
        document.getElementById("loadingMessage").textContent = message;
        modal.classList.remove("hidden");
        modal.classList.add("modal-show");
    }

    function hideLoadingModal() {
        const modal = document.getElementById("loadingModal");
        modal.classList.add("hidden");
        modal.classList.remove("modal-show");
    }

    document
        .getElementById("addBaseForm")
        .addEventListener("submit", async (e) => {
            e.preventDefault();
            const baseId = document.getElementById("base_id").value;
            const tableName = document.getElementById("table_name").value;

            // Show loading modal with animation
            showLoadingModal(
                "Scanning Table",
                "AI is analyzing your Airtable structure and detecting fields...",
            );

            const resultDiv = document.getElementById("addBaseResult");
            resultDiv.classList.add("hidden");

            try {
                const response = await fetch("/api/add-base", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        base_id: baseId,
                        table_name: tableName,
                    }),
                });

                const data = await response.json();
                hideLoadingModal();

                if (response.ok) {
                    // Check if there are missing fields
                    if (data.missing_fields && data.missing_fields.length > 0) {
                        // Store data for modal
                        window.pendingMissingFields = {
                            baseId: data.base_id,
                            airtableBase: baseId,
                            tableName: tableName,
                            missingFields: data.missing_fields,
                        };

                        // Show custom modal
                        const fieldsList =
                            document.getElementById("missingFieldsList");
                        fieldsList.innerHTML = data.missing_fields
                            .map(
                                (field) =>
                                    `<li>${fieldLabels[field] || field}</li>`,
                            )
                            .join("");
                        document
                            .getElementById("missingFieldsConfirmModal")
                            .classList.remove("hidden");
                    } else {
                        resultDiv.innerHTML = `
                    <div class="bg-green-50 border border-green-200 rounded-lg p-4 animate-pulse">
                        <p class="text-green-700 font-medium mb-2">
                            <i class="fas fa-check-circle mr-2"></i>
                            Base added successfully!
                        </p>
                        <p class="text-sm text-gray-600">All fields detected. Refreshing page...</p>
                    </div>
                `;
                        resultDiv.classList.remove("hidden");
                        setTimeout(() => location.reload(), 1500);
                    }
                } else {
                    resultDiv.innerHTML = `
                <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                    <p class="text-red-700">
                        <i class="fas fa-exclamation-circle mr-2"></i>
                        Error: ${data.error}
                    </p>
                </div>
            `;
                    resultDiv.classList.remove("hidden");
                }
            } catch (error) {
                hideLoadingModal();
                resultDiv.innerHTML = `
            <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                <p class="text-red-700">
                    <i class="fas fa-exclamation-circle mr-2"></i>
                    Error: ${error.message}
                </p>
            </div>
        `;
                resultDiv.classList.remove("hidden");
            }
        });

    let selectedRecordId = null;
    let selectedRecordIds = [];
    let bulkMode = false;
    let searchTimeout = null;

    function toggleBulkMode() {
        bulkMode = document.getElementById("bulkModeToggle").checked;
        selectedRecordIds = [];
        selectedRecordId = null;

        // Update UI
        document
            .getElementById("selectedCount")
            .classList.toggle("hidden", !bulkMode);
        document.getElementById("selectedCountNum").textContent = "0";
        document.getElementById("startReviewBtnText").textContent = bulkMode
            ? "Start Bulk Review"
            : "Start Review";
        document.getElementById("startReviewBtn").disabled = true;

        // Re-search to update checkboxes
        if (document.getElementById("record_search").value) {
            searchRecords();
        }
    }

    function startReviewPrompt(baseId, tableName) {
        currentBaseId = baseId;
        currentTableName = tableName;
        selectedRecordId = null;
        selectedRecordIds = [];
        bulkMode = false;

        const modal = document.getElementById("reviewModal");
        const content = document.getElementById("reviewModalContent");

        // Reset UI
        document.getElementById("bulkModeToggle").checked = false;
        document.getElementById("selectedCount").classList.add("hidden");
        document.getElementById("record_search").value = "";
        document.getElementById("record_results").innerHTML = `
        <div class="p-8 text-center text-gray-500">
            <i class="fas fa-search text-4xl mb-3"></i>
            <p>Search for records to review</p>
        </div>
    `;
        document.getElementById("startReviewBtn").disabled = true;
        document.getElementById("startReviewBtnText").textContent =
            "Start Review";

        modal.classList.remove("hidden");
        setTimeout(() => {
            content.classList.remove("scale-95");
            content.classList.add("scale-100");
            document.getElementById("record_search").focus();
        }, 10);
    }

    function closeReviewModal() {
        const modal = document.getElementById("reviewModal");
        const content = document.getElementById("reviewModalContent");
        content.classList.add("scale-95");
        content.classList.remove("scale-100");
        setTimeout(() => {
            modal.classList.add("hidden");
            selectedRecordId = null;
        }, 300);
    }

    async function searchRecords() {
        const query = document.getElementById("record_search").value;
        const resultsDiv = document.getElementById("record_results");

        // Clear previous timeout
        if (searchTimeout) clearTimeout(searchTimeout);

        // Show loading
        resultsDiv.innerHTML = `
        <div class="p-8 text-center text-gray-500">
            <i class="fas fa-spinner fa-spin text-4xl mb-3"></i>
            <p>Searching...</p>
        </div>
    `;

        // Debounce search
        searchTimeout = setTimeout(async () => {
            try {
                const response = await fetch("/api/search-records", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        base_id: currentBaseId,
                        table_name: currentTableName,
                        search_query: query,
                    }),
                });

                const data = await response.json();

                if (response.ok && data.records.length > 0) {
                    resultsDiv.innerHTML = data.records
                        .map((record) => {
                            const fieldsPreview = Object.entries(record.fields)
                                .slice(0, 3)
                                .map(
                                    ([key, value]) =>
                                        `<div class="text-xs"><strong>${key}:</strong> ${String(value).substring(0, 50)}</div>`,
                                )
                                .join("");

                            const isSelected =
                                bulkMode &&
                                selectedRecordIds.includes(record.id);

                            if (bulkMode) {
                                return `
                            <div class="p-4 border-b border-gray-200 hover:bg-blue-50 cursor-pointer transition-all record-item ${isSelected ? "bg-blue-100" : ""}"
                                 onclick="toggleRecordSelection('${record.id}', this)">
                                <div class="flex items-start justify-between">
                                    <div class="flex items-center mr-3">
                                        <input type="checkbox" ${isSelected ? "checked" : ""} class="w-5 h-5" onclick="event.stopPropagation(); toggleRecordSelection('${record.id}', this.closest('.record-item'))">
                                    </div>
                                    <div class="flex-1">
                                        <p class="font-medium text-gray-900 mb-1">
                                            <i class="fas fa-file-alt mr-2 text-gray-400"></i>
                                            ${record.id}
                                        </p>
                                        <div class="text-gray-600 space-y-1">
                                            ${fieldsPreview}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                            } else {
                                return `
                            <div class="p-4 border-b border-gray-200 hover:bg-blue-50 cursor-pointer transition-all record-item"
                                 onclick="selectRecord('${record.id}', this)">
                                <div class="flex items-start justify-between">
                                    <div class="flex-1">
                                        <p class="font-medium text-gray-900 mb-1">
                                            <i class="fas fa-file-alt mr-2 text-gray-400"></i>
                                            ${record.id}
                                        </p>
                                        <div class="text-gray-600 space-y-1">
                                            ${fieldsPreview}
                                        </div>
                                    </div>
                                    <i class="fas fa-chevron-right text-gray-400"></i>
                                </div>
                            </div>
                        `;
                            }
                        })
                        .join("");
                } else {
                    resultsDiv.innerHTML = `
                    <div class="p-8 text-center text-gray-500">
                        <i class="fas fa-inbox text-4xl mb-3"></i>
                        <p>No records found</p>
                    </div>
                `;
                }
            } catch (error) {
                resultsDiv.innerHTML = `
                <div class="p-8 text-center text-red-500">
                    <i class="fas fa-exclamation-circle text-4xl mb-3"></i>
                    <p>Error: ${error.message}</p>
                </div>
            `;
            }
        }, 500);
    }

    function selectRecord(recordId, element) {
        selectedRecordId = recordId;

        // Remove previous selection
        document.querySelectorAll(".record-item").forEach((item) => {
            item.classList.remove(
                "bg-blue-100",
                "border-l-4",
                "border-blue-500",
            );
        });

        // Highlight selected
        element.classList.add("bg-blue-100", "border-l-4", "border-blue-500");

        // Enable button
        document.getElementById("startReviewBtn").disabled = false;
    }

    function toggleRecordSelection(recordId, element) {
        const checkbox = element.querySelector('input[type="checkbox"]');

        if (selectedRecordIds.includes(recordId)) {
            selectedRecordIds = selectedRecordIds.filter(
                (id) => id !== recordId,
            );
            element.classList.remove("bg-blue-100");
            if (checkbox) checkbox.checked = false;
        } else {
            selectedRecordIds.push(recordId);
            element.classList.add("bg-blue-100");
            if (checkbox) checkbox.checked = true;
        }

        // Update count and button state
        document.getElementById("selectedCountNum").textContent =
            selectedRecordIds.length;
        document.getElementById("startReviewBtn").disabled =
            selectedRecordIds.length === 0;
    }

    async function startReviewWithSelected() {
        if (bulkMode) {
            if (selectedRecordIds.length === 0) {
                showNotification("Please select at least one record", "error");
                return;
            }

            closeReviewModal();
            showLoadingModal(
                "Starting Bulk Review",
                `Initializing ${selectedRecordIds.length} review jobs...`,
            );

            try {
                const response = await fetch("/api/bulk-review", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        base_id: currentBaseId,
                        table_name: currentTableName,
                        record_ids: selectedRecordIds,
                    }),
                });

                hideLoadingModal();

                if (response.ok) {
                    const data = await response.json();
                    showNotification(
                        `Successfully started ${data.count} review jobs!`,
                        "success",
                    );
                    setTimeout(() => {
                        window.location.href = "/jobs";
                    }, 1000);
                } else {
                    const data = await response.json();
                    showNotification("Error: " + data.error, "error");
                }
            } catch (error) {
                hideLoadingModal();
                showNotification("Error: " + error.message, "error");
            }
        } else {
            if (!selectedRecordId) {
                showNotification("Please select a record", "error");
                return;
            }

            closeReviewModal();
            showLoadingModal(
                "Starting Review",
                "Initializing automated review process...",
            );

            try {
                const response = await fetch("/api/start-review", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        base_id: currentBaseId,
                        table_name: currentTableName,
                        record_id: selectedRecordId,
                    }),
                });

                hideLoadingModal();

                if (response.ok) {
                    showNotification("Review started successfully!", "success");
                    setTimeout(() => {
                        window.location.href = "/jobs";
                    }, 1000);
                } else {
                    const data = await response.json();
                    showNotification("Error: " + data.error, "error");
                }
            } catch (error) {
                hideLoadingModal();
                showNotification("Error: " + error.message, "error");
            }
        }
    }

    // Missing fields confirmation modal handlers
    function proceedToAddFields() {
        if (window.pendingMissingFields) {
            const data = window.pendingMissingFields;
            sessionStorage.setItem("showFieldModal", JSON.stringify(data));
            location.reload();
        }
    }

    function skipAddingFields() {
        document
            .getElementById("missingFieldsConfirmModal")
            .classList.add("hidden");
        window.pendingMissingFields = null;
        location.reload();
    }

    // Delete base functionality
    let deleteBaseId = null;

    function confirmDeleteBase(baseId, tableName) {
        console.log("Deleting base:", baseId, tableName);
        if (!baseId || baseId === "null" || baseId === "undefined") {
            showNotification("Invalid base ID", "error");
            return;
        }
        deleteBaseId = baseId;
        document.getElementById("deleteBaseInfo").textContent =
            `Are you sure you want to delete "${tableName}"? This action cannot be undone.`;
        document.getElementById("deleteModal").classList.remove("hidden");
    }

    function showNotification(message, type = "info") {
        const notif = document.createElement("div");
        notif.className = `fixed top-4 right-4 px-6 py-3 rounded-lg shadow-lg z-50 animate-slideIn ${
            type === "error"
                ? "bg-red-50 border border-red-200 text-red-700"
                : type === "success"
                  ? "bg-green-50 border border-green-200 text-green-700"
                  : "bg-blue-50 border border-blue-200 text-blue-700"
        }`;
        notif.innerHTML = `
        <i class="fas ${type === "error" ? "fa-exclamation-circle" : type === "success" ? "fa-check-circle" : "fa-info-circle"} mr-2"></i>
        ${message}
    `;
        document.body.appendChild(notif);
        setTimeout(() => {
            notif.style.opacity = "0";
            setTimeout(() => notif.remove(), 300);
        }, 3000);
    }

    function closeDeleteModal() {
        document.getElementById("deleteModal").classList.add("hidden");
        deleteBaseId = null;
    }

    async function deleteBase() {
        if (!deleteBaseId || deleteBaseId === "null") {
            showNotification("Invalid base ID", "error");
            return;
        }

        // Store the ID before closing modal (which sets it to null)
        const idToDelete = deleteBaseId;

        closeDeleteModal();
        showLoadingModal("Deleting Base", "Removing base configuration...");

        try {
            const response = await fetch(`/api/delete-base/${idToDelete}`, {
                method: "DELETE",
            });

            hideLoadingModal();

            if (response.ok) {
                showNotification("Base deleted successfully", "success");
                setTimeout(() => location.reload(), 1000);
            } else if (response.status === 404) {
                showNotification("Base not found or already deleted", "error");
                setTimeout(() => location.reload(), 1000);
            } else {
                const contentType = response.headers.get("content-type");
                if (contentType && contentType.includes("application/json")) {
                    const data = await response.json();
                    showNotification("Error: " + data.error, "error");
                } else {
                    showNotification(
                        "Error deleting base: Server error",
                        "error",
                    );
                }
            }
        } catch (error) {
            hideLoadingModal();
            showNotification("Error: " + error.message, "error");
        }
    }

    // Missing fields functionality
    let currentFieldBaseId = null;
    let currentFieldAirtableBase = null;
    let currentFieldTableName = null;

    const fieldLabels = {
        code_url: "Code URL (GitHub)",
        playable_url: "Playable URL (Demo)",
        hackatime_hours: "Hackatime Hours",
        auto_review_notes: "Auto Review Notes",
        auto_user_feedback: "Auto User Feedback",
        auto_review_tag: "Auto Review Tag",
    };

    const fieldTypes = {
        code_url: "URL",
        playable_url: "URL",
        hackatime_hours: "Number",
        auto_review_notes: "Long text",
        auto_user_feedback: "Long text",
        auto_review_tag: "Single select",
    };

    const fieldDescriptions = {
        code_url: "The GitHub repository URL for the project",
        playable_url: "The live demo/deployed website URL",
        hackatime_hours: "Number of hours worked on the project",
        auto_review_notes: "Internal review notes (for admin use only)",
        auto_user_feedback: "User-facing feedback message",
        auto_review_tag: "Review decision status",
    };

    const fieldIcons = {
        code_url: "fa-github",
        playable_url: "fa-globe",
        hackatime_hours: "fa-clock",
        auto_review_notes: "fa-sticky-note",
        auto_user_feedback: "fa-comment-dots",
        auto_review_tag: "fa-tag",
    };

    const fieldInstructions = {
        code_url: [
            "Click the <strong>+</strong> button in Airtable",
            "Select field type: <strong>URL</strong>",
            "Name it something like: <code>Code URL</code> or <code>GitHub Link</code>",
            "Click Create"
        ],
        playable_url: [
            "Click the <strong>+</strong> button in Airtable",
            "Select field type: <strong>URL</strong>",
            "Name it something like: <code>Playable URL</code> or <code>Demo Link</code>",
            "Click Create"
        ],
        hackatime_hours: [
            "Click the <strong>+</strong> button in Airtable",
            "Select field type: <strong>Number</strong>",
            "Name it something like: <code>Hours Worked</code> or <code>Hackatime Hours</code>",
            "Set precision: <strong>Allow decimal numbers (0.1)</strong>",
            "Click Create"
        ],
        auto_review_notes: [
            "Click the <strong>+</strong> button in Airtable",
            "Select field type: <strong>Long text</strong>",
            "Name it: <code>Auto Review Notes</code>",
            "Enable <strong>rich text formatting</strong> (optional)",
            "Click Create"
        ],
        auto_user_feedback: [
            "Click the <strong>+</strong> button in Airtable",
            "Select field type: <strong>Long text</strong>",
            "Name it: <code>Auto User Feedback</code>",
            "Enable <strong>rich text formatting</strong> (optional)",
            "Click Create"
        ],
        auto_review_tag: [
            "Click the <strong>+</strong> button in Airtable",
            "Select field type: <strong>Single select</strong>",
            "Name it: <code>Auto Review Tag</code>",
            "<strong>IMPORTANT:</strong> Add exactly these 3 options:",
            "&nbsp;&nbsp;• <span class='px-2 py-1 bg-green-100 text-green-800 rounded'>Approved</span> (color: green)",
            "&nbsp;&nbsp;• <span class='px-2 py-1 bg-yellow-100 text-yellow-800 rounded'>Flagged</span> (color: yellow)",
            "&nbsp;&nbsp;• <span class='px-2 py-1 bg-red-100 text-red-800 rounded'>Error</span> (color: red)",
            "Click Create"
        ]
    };

    function showFieldModal(baseId, airtableBase, tableName) {
        currentFieldBaseId = baseId;
        currentFieldAirtableBase = airtableBase;
        currentFieldTableName = tableName;

        // Find missing fields
        const baseElement = document
            .querySelector(`button[data-base-id="${baseId}"]`)
            .closest(".p-6");
        const mappingDiv = baseElement.querySelector(".bg-gray-50");
        const spans = mappingDiv.querySelectorAll("span");
        const missingFields = [];

        spans.forEach((span, index) => {
            if (span.textContent.trim() === "Missing") {
                const keys = [
                    "code_url",
                    "playable_url",
                    "hackatime_hours",
                    "auto_review_notes",
                    "auto_user_feedback",
                    "auto_review_tag",
                ];
                missingFields.push(keys[index]);
            }
        });

        showFieldModalDirect(baseId, airtableBase, tableName, missingFields);
    }

    function showFieldModalDirect(
        baseId,
        airtableBase,
        tableName,
        missingFields,
    ) {
        currentFieldBaseId = baseId;
        currentFieldAirtableBase = airtableBase;
        currentFieldTableName = tableName;

        // Create detailed field setup cards
        const inputsDiv = document.getElementById("fieldInputs");
        inputsDiv.innerHTML = missingFields
            .map(
                (field, index) => `
        <div class="bg-white border-2 border-gray-300 rounded-xl p-5 shadow-sm hover:shadow-md transition-all">
            <div class="flex items-start mb-4">
                <div class="flex-shrink-0 w-10 h-10 bg-gradient-to-br from-blue-500 to-purple-600 rounded-lg flex items-center justify-center text-white font-bold mr-4">
                    ${index + 1}
                </div>
                <div class="flex-1">
                    <h4 class="text-lg font-bold text-gray-900 mb-1">
                        <i class="fas ${fieldIcons[field]} mr-2 text-blue-600"></i>
                        ${fieldLabels[field]}
                    </h4>
                    <p class="text-sm text-gray-600 mb-2">
                        ${fieldDescriptions[field]}
                    </p>
                    <div class="inline-flex items-center px-3 py-1 bg-purple-100 text-purple-800 text-xs font-bold rounded-full">
                        <i class="fas fa-info-circle mr-1"></i>
                        Field Type: ${fieldTypes[field]}
                    </div>
                </div>
            </div>

            <div class="bg-gradient-to-r from-blue-50 to-purple-50 rounded-lg p-4 mb-4 border border-blue-200">
                <h5 class="font-bold text-sm text-blue-900 mb-2">
                    <i class="fas fa-list-ol mr-1"></i>
                    Step-by-Step Instructions:
                </h5>
                <ol class="text-sm text-blue-800 space-y-1 ml-4">
                    ${fieldInstructions[field].map((instruction, idx) =>
                        `<li class="flex items-start">
                            <span class="font-bold mr-2">${idx + 1}.</span>
                            <span>${instruction}</span>
                        </li>`
                    ).join('')}
                </ol>
            </div>

            <div class="flex items-center gap-3">
                <div class="flex-1">
                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                        <i class="fas fa-pencil-alt mr-1"></i>
                        Enter the field name you created in Airtable:
                    </label>
                    <input type="text"
                           id="field_${field}"
                           data-key="${field}"
                           placeholder="e.g., ${fieldLabels[field]}"
                           class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 font-medium">
                </div>
                <div class="flex-shrink-0 pt-7">
                    <button onclick="document.getElementById('field_${field}').value = '${fieldLabels[field]}'"
                            class="px-3 py-2 bg-gray-200 hover:bg-gray-300 text-gray-700 text-xs rounded-lg transition-all"
                            title="Use default name">
                        <i class="fas fa-magic mr-1"></i>
                        Use Default
                    </button>
                </div>
            </div>
        </div>
    `,
            )
            .join("");

        document.getElementById("fieldModal").classList.remove("hidden");
    }

    function closeFieldModal() {
        document.getElementById("fieldModal").classList.add("hidden");
        currentFieldBaseId = null;
        currentFieldAirtableBase = null;
        currentFieldTableName = null;
    }

    async function updateFieldMappings() {
        const inputs = document.querySelectorAll("#fieldInputs input");
        const updates = [];

        for (const input of inputs) {
            const fieldName = input.value.trim();
            const fieldKey = input.dataset.key;

            if (fieldName) {
                updates.push({ field_key: fieldKey, field_name: fieldName });
            }
        }

        if (updates.length === 0) {
            showNotification("Please enter at least one field name", "error");
            return;
        }

        closeFieldModal();
        showLoadingModal("Updating Mappings", "Saving field configurations...");

        try {
            for (const update of updates) {
                const response = await fetch("/api/create-field", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        base_id: currentFieldAirtableBase,
                        table_name: currentFieldTableName,
                        field_name: update.field_name,
                        field_key: update.field_key,
                    }),
                });

                if (!response.ok) {
                    const data = await response.json();
                    throw new Error(data.error);
                }
            }

            hideLoadingModal();
            showNotification("Field mappings updated successfully!", "success");
            setTimeout(() => location.reload(), 1000);
        } catch (error) {
            hideLoadingModal();
            showNotification(
                "Error updating fields: " + error.message,
                "error",
            );
        }
    }

    // Inline Edit Functions
    function toggleEditMode(baseId) {
        const viewDiv = document.getElementById(`mappings-view-${baseId}`);
        const editDiv = document.getElementById(`mappings-edit-${baseId}`);
        const saveBtn = document.getElementById(`save-mappings-${baseId}`);
        const btnText = document.getElementById(`edit-btn-text-${baseId}`);

        if (editDiv.classList.contains("hidden")) {
            // Enter edit mode
            viewDiv.classList.add("hidden");
            editDiv.classList.remove("hidden");
            saveBtn.classList.remove("hidden");
            btnText.textContent = "Cancel";
        } else {
            // Exit edit mode
            viewDiv.classList.remove("hidden");
            editDiv.classList.add("hidden");
            saveBtn.classList.add("hidden");
            btnText.textContent = "Edit";
        }
    }

    async function saveInlineMappings(baseId, dataset) {
        const editDiv = document.getElementById(`mappings-edit-${baseId}`);
        const inputs = editDiv.querySelectorAll("input");
        const newMappings = {};

        inputs.forEach((input) => {
            const fieldKey = input.dataset.field;
            const fieldValue = input.value.trim();
            newMappings[fieldKey] = fieldValue || "null";
        });

        console.log("Saving mappings:", {
            base_id: dataset.airtableBase,
            table_name: dataset.tableName,
            mappings: newMappings,
        });

        try {
            const response = await fetch("/api/edit-field-mappings", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    base_id: dataset.airtableBase,
                    table_name: dataset.tableName,
                    mappings: newMappings,
                }),
            });

            const data = await response.json();

            if (response.ok) {
                showNotification(
                    "Field mappings updated successfully!",
                    "success",
                );
                setTimeout(() => location.reload(), 1000);
            } else {
                showNotification("Error: " + data.error, "error");
                console.error("Save error:", data);
            }
        } catch (error) {
            showNotification("Error: " + error.message, "error");
            console.error("Request error:", error);
        }
    }

    // Re-scan field mappings
    async function rescanFieldMappings(dataset) {
        const airtableBase = dataset.airtableBase;
        const tableName = dataset.tableName;
        const dbId = dataset.dbId;

        // Button confirmation pattern
        const btn = event.target.closest("button");
        const originalHtml = btn.innerHTML;

        // Show confirmation in button
        btn.innerHTML =
            '<i class="fas fa-exclamation-triangle"></i> Sure? Click again';
        btn.classList.add("bg-yellow-600");
        btn.classList.remove("bg-blue-600");

        // Wait for second click
        const confirmed = await new Promise((resolve) => {
            const timeout = setTimeout(() => {
                btn.innerHTML = originalHtml;
                btn.classList.remove("bg-yellow-600");
                btn.classList.add("bg-blue-600");
                resolve(false);
            }, 3000);

            btn.onclick = () => {
                clearTimeout(timeout);
                btn.onclick = () => rescanFieldMappings(dataset);
                resolve(true);
            };
        });

        if (!confirmed) return;

        btn.innerHTML = originalHtml;
        btn.classList.remove("bg-yellow-600");
        btn.classList.add("bg-blue-600");

        showLoadingModal(
            "Re-scanning Fields",
            "AI is analyzing your Airtable structure...",
        );

        try {
            const response = await fetch("/api/rescan-fields", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    base_id: airtableBase,
                    table_name: tableName,
                    db_id: dbId,
                }),
            });

            hideLoadingModal();

            if (response.ok) {
                const data = await response.json();
                showNotification(
                    "Field mappings re-scanned successfully!",
                    "success",
                );
                setTimeout(() => location.reload(), 1000);
            } else {
                const data = await response.json();
                showNotification("Error: " + data.error, "error");
            }
        } catch (error) {
            hideLoadingModal();
            showNotification("Error: " + error.message, "error");
        }
    }

    // Custom instructions modal
    function openCustomInstructions(dataset) {
        const dbId = dataset.dbId;
        const currentInstructions = dataset.customInstructions || "";

        const modal = document.getElementById("customInstructionsModal");
        const textarea = document.getElementById("customInstructionsText");
        const saveBtn = document.getElementById("saveCustomInstructions");

        textarea.value = currentInstructions;
        saveBtn.dataset.dbId = dbId;

        modal.classList.remove("hidden");
    }

    function closeCustomInstructions() {
        document
            .getElementById("customInstructionsModal")
            .classList.add("hidden");
    }

    async function saveCustomInstructions() {
        const btn = document.getElementById("saveCustomInstructions");
        const dbId = btn.dataset.dbId;
        const instructions = document.getElementById(
            "customInstructionsText",
        ).value;

        const originalText = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Saving...';

        try {
            const response = await fetch("/api/update-custom-instructions", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    db_id: dbId,
                    custom_instructions: instructions,
                }),
            });

            if (response.ok) {
                showNotification(
                    "Custom instructions saved successfully!",
                    "success",
                );
                setTimeout(() => {
                    closeCustomInstructions();
                    location.reload();
                }, 1000);
            } else {
                const data = await response.json();
                showNotification("Error: " + data.error, "error");
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        } catch (error) {
            showNotification("Error: " + error.message, "error");
            btn.innerHTML = originalText;
            btn.disabled = false;
        }
    }
</script>

<!-- Custom Instructions Modal -->
<div
    id="customInstructionsModal"
    class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50"
>
    <div class="bg-white rounded-2xl p-6 max-w-2xl w-full mx-4 shadow-2xl">
        <div class="flex items-center justify-between mb-6">
            <h3 class="text-2xl font-bold text-gray-900">
                <i class="fas fa-clipboard-list mr-2 text-green-600"></i>
                Custom Review Instructions
            </h3>
            <button
                onclick="closeCustomInstructions()"
                class="text-gray-400 hover:text-gray-600"
            >
                <i class="fas fa-times text-2xl"></i>
            </button>
        </div>

        <div class="mb-4">
            <p class="text-sm text-gray-600 mb-4">
                Add custom instructions to guide the AI reviewer for this
                specific base. These will be included in all reviews for this
                table.
            </p>
            <p class="text-xs text-gray-500 mb-4">
                <strong>Examples:</strong><br />
                • "Look for proper error handling in all API calls"<br />
                • "Projects must include at least 3 pages"<br />
                • "Prioritize accessibility features in the review"
            </p>
            <textarea
                id="customInstructionsText"
                rows="8"
                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"
                placeholder="Enter custom instructions for the AI reviewer..."
            ></textarea>
        </div>

        <div class="flex gap-3">
            <button
                id="saveCustomInstructions"
                onclick="saveCustomInstructions()"
                class="flex-1 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700"
            >
                <i class="fas fa-save mr-2"></i>
                Save Instructions
            </button>
            <button
                onclick="closeCustomInstructions()"
                class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300"
            >
                Cancel
            </button>
        </div>
    </div>
</div>

{% endblock %}
