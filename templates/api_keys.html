{% extends "base.html" %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
    <div class="mb-8">
        <h1 class="text-3xl font-bold text-gray-900">
            <i class="fas fa-key mr-2 text-purple-500"></i>
            API Keys
        </h1>
        <p class="mt-2 text-sm text-gray-600">Create API keys to trigger reviews from Airtable automations</p>
    </div>

    <!-- Create New Key -->
    <div class="bg-white rounded-lg shadow-md p-6 mb-6">
        <h2 class="text-xl font-semibold mb-4">Create New API Key</h2>
        <div class="flex gap-3">
            <input type="text" id="keyName" placeholder="API Key Name (e.g., 'Airtable Production')"
                   class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
            <button onclick="createApiKey()"
                    class="px-6 py-2 bg-purple-600 text-white font-medium rounded-lg hover:bg-purple-700 transition-all">
                <i class="fas fa-plus mr-2"></i>
                Create Key
            </button>
        </div>
    </div>

    <!-- API Keys List -->
    <div class="bg-white rounded-lg shadow-md overflow-hidden">
        <div class="px-6 py-4 bg-purple-50 border-b border-purple-200">
            <h2 class="text-xl font-semibold text-gray-900">Your API Keys</h2>
        </div>
        <div id="apiKeysList" class="divide-y divide-gray-200">
            {% if api_keys %}
                {% for key in api_keys %}
                <div class="p-6 hover:bg-gray-50" data-key-id="{{ key.id }}">
                    <div class="flex items-start justify-between">
                        <div class="flex-1">
                            <div class="flex items-center gap-3">
                                <h3 class="text-lg font-medium text-gray-900">{{ key.name }}</h3>
                                {% if key.is_active %}
                                <span class="px-2 py-1 bg-green-100 text-green-800 text-xs rounded-full">Active</span>
                                {% else %}
                                <span class="px-2 py-1 bg-gray-100 text-gray-800 text-xs rounded-full">Inactive</span>
                                {% endif %}
                            </div>
                            <div class="mt-2 space-y-1 text-sm text-gray-600">
                                <p><i class="fas fa-calendar mr-2"></i>Created: {{ key.created_at.strftime('%Y-%m-%d %H:%M') }}</p>
                                {% if key.last_used %}
                                <p><i class="fas fa-clock mr-2"></i>Last Used: {{ key.last_used.strftime('%Y-%m-%d %H:%M') }}</p>
                                {% endif %}
                                <div class="flex items-center gap-2 mt-3">
                                    <code class="bg-gray-100 px-3 py-1 rounded font-mono text-xs">{{ key.key[:20] }}...</code>
                                    <button onclick="copyApiKey('{{ key.key }}')" class="text-purple-600 hover:text-purple-800">
                                        <i class="fas fa-copy"></i> Copy
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="toggleApiKey({{ key.id }})"
                                    class="px-3 py-1 bg-blue-600 text-white text-sm rounded hover:bg-blue-700">
                                {% if key.is_active %}Disable{% else %}Enable{% endif %}
                            </button>
                            <button onclick="deleteApiKey({{ key.id }})"
                                    class="px-3 py-1 bg-red-600 text-white text-sm rounded hover:bg-red-700">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
                {% endfor %}
            {% else %}
            <div class="p-8 text-center text-gray-500">
                <i class="fas fa-key text-4xl mb-3"></i>
                <p>No API keys yet. Create one to get started!</p>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Documentation -->
    <div class="mt-8 bg-blue-50 rounded-lg border border-blue-200 p-6">
        <h2 class="text-xl font-semibold text-gray-900 mb-4">
            <i class="fas fa-book mr-2 text-blue-600"></i>
            API Documentation & Airtable Integration
        </h2>

        <div class="space-y-6">
            <div>
                <h3 class="font-semibold text-gray-900 mb-2">API Endpoint</h3>
                <code class="block bg-white p-3 rounded border border-blue-300 text-sm">
                    POST {{ request.url_root }}api/v1/review
                </code>
            </div>

            <div>
                <h3 class="font-semibold text-gray-900 mb-2">Authentication</h3>
                <p class="text-sm text-gray-700 mb-2">Include your API key in the request header:</p>
                <code class="block bg-white p-3 rounded border border-blue-300 text-sm">
                    X-API-Key: your_api_key_here
                </code>
            </div>

            <div>
                <h3 class="font-semibold text-gray-900 mb-2">Request Body</h3>
                <pre class="bg-white p-3 rounded border border-blue-300 text-sm overflow-x-auto">
{
    "base_id": "appXXXXXXXXXXXXXX",
    "table_name": "Your Table Name",
    "record_id": "recXXXXXXXXXXXXXX"
}</pre>
            </div>

            <div>
                <h3 class="font-semibold text-gray-900 mb-2">Airtable Automation Script Example</h3>
                <p class="text-sm text-gray-700 mb-2">Add this script to your Airtable automation (when record is created/updated):</p>
                <pre class="bg-white p-3 rounded border border-blue-300 text-sm overflow-x-auto">
// Airtable Automation Script
// Trigger: When record is created or matches conditions

let config = input.config();
let recordId = config.recordId; // From trigger

// Your API configuration
const API_URL = "{{ request.url_root }}api/v1/review";
const API_KEY = "your_api_key_here"; // Replace with your actual API key
const BASE_ID = "appXXXXXXXXXXXXXX"; // Your Airtable base ID
const TABLE_NAME = "Your Table Name"; // Your table name

// Make the API request
let response = await fetch(API_URL, {
    method: 'POST',
    headers: {
        'Content-Type': 'application/json',
        'X-API-Key': API_KEY
    },
    body: JSON.stringify({
        base_id: BASE_ID,
        table_name: TABLE_NAME,
        record_id: recordId
    })
});

let result = await response.json();
console.log('Review started:', result);</pre>
            </div>

            <div>
                <h3 class="font-semibold text-gray-900 mb-2">Alternative: Webhook URL</h3>
                <p class="text-sm text-gray-700 mb-2">You can also use this URL in Airtable webhooks:</p>
                <code class="block bg-white p-3 rounded border border-blue-300 text-sm break-all">
                    {{ request.url_root }}api/v1/review?api_key=YOUR_API_KEY
                </code>
                <p class="text-xs text-gray-600 mt-2">Note: Include base_id, table_name, and record_id in the POST body</p>
            </div>
        </div>
    </div>
</div>

<!-- New Key Modal -->
<div id="newKeyModal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50">
    <div class="bg-white rounded-2xl p-6 max-w-2xl w-full mx-4 shadow-2xl">
        <div class="flex items-center justify-between mb-6">
            <h3 class="text-2xl font-bold text-gray-900">
                <i class="fas fa-check-circle mr-2 text-green-600"></i>
                API Key Created!
            </h3>
            <button onclick="closeNewKeyModal()" class="text-gray-400 hover:text-gray-600">
                <i class="fas fa-times text-2xl"></i>
            </button>
        </div>

        <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-4">
            <p class="text-sm text-yellow-800">
                <i class="fas fa-exclamation-triangle mr-2"></i>
                <strong>Important:</strong> Copy this API key now. You won't be able to see it again!
            </p>
        </div>

        <div id="newKeyContent" class="space-y-4">
            <!-- Will be populated by JavaScript -->
        </div>

        <div class="mt-6 flex gap-3">
            <button onclick="copyNewApiKey()" class="flex-1 px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700">
                <i class="fas fa-copy mr-2"></i>
                Copy API Key
            </button>
            <button onclick="closeNewKeyModal()" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300">
                Close
            </button>
        </div>
    </div>
</div>

<script>
let newApiKeyValue = '';

async function createApiKey() {
    const nameInput = document.getElementById('keyName');
    const name = nameInput.value.trim();

    if (!name) {
        nameInput.classList.add('border-red-500', 'ring-2', 'ring-red-200');
        setTimeout(() => {
            nameInput.classList.remove('border-red-500', 'ring-2', 'ring-red-200');
        }, 2000);
        return;
    }

    try {
        const response = await fetch('/api/create-api-key', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name })
        });

        const result = await response.json();

        if (result.success) {
            newApiKeyValue = result.api_key;
            document.getElementById('newKeyContent').innerHTML = `
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Key Name</label>
                    <div class="bg-gray-100 px-4 py-2 rounded">${result.name}</div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">API Key</label>
                    <div class="bg-gray-100 px-4 py-2 rounded font-mono text-sm break-all">${result.api_key}</div>
                </div>
            `;
            document.getElementById('newKeyModal').classList.remove('hidden');
            document.getElementById('keyName').value = '';
        } else {
            showError('Failed to create API key: ' + result.error);
        }
    } catch (error) {
        showError('Error creating API key: ' + error.message);
    }
}

function showError(message) {
    const errorDiv = document.createElement('div');
    errorDiv.className = 'fixed top-4 right-4 bg-red-100 border border-red-400 text-red-700 px-6 py-4 rounded-lg shadow-lg z-50 max-w-md';
    errorDiv.innerHTML = `
        <div class="flex items-center gap-3">
            <i class="fas fa-exclamation-circle text-xl"></i>
            <span>${message}</span>
            <button onclick="this.parentElement.parentElement.remove()" class="ml-2">
                <i class="fas fa-times"></i>
            </button>
        </div>
    `;
    document.body.appendChild(errorDiv);
    setTimeout(() => errorDiv.remove(), 5000);
}

function copyNewApiKey() {
    navigator.clipboard.writeText(newApiKeyValue);
    const btn = event.target.closest('button');
    const originalText = btn.innerHTML;
    btn.innerHTML = '<i class="fas fa-check mr-2"></i>Copied!';
    setTimeout(() => {
        btn.innerHTML = originalText;
    }, 2000);
}

function closeNewKeyModal() {
    document.getElementById('newKeyModal').classList.add('hidden');
    location.reload();
}

function copyApiKey(key) {
    navigator.clipboard.writeText(key);
    const btn = event.target.closest('button');
    const originalText = btn.innerHTML;
    btn.innerHTML = '<i class="fas fa-check"></i> Copied!';
    setTimeout(() => {
        btn.innerHTML = originalText;
    }, 2000);
}

async function deleteApiKey(keyId) {
    const btn = event.target.closest('button');
    const originalHtml = btn.innerHTML;

    // Show confirmation in button
    btn.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Sure?';
    btn.classList.add('bg-yellow-600');
    btn.classList.remove('bg-red-600');

    // Wait for second click
    const confirmDelete = await new Promise(resolve => {
        const timeout = setTimeout(() => {
            btn.innerHTML = originalHtml;
            btn.classList.remove('bg-yellow-600');
            btn.classList.add('bg-red-600');
            resolve(false);
        }, 3000);

        btn.onclick = () => {
            clearTimeout(timeout);
            btn.onclick = null;
            resolve(true);
        };
    });

    if (!confirmDelete) return;

    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
    btn.disabled = true;

    try {
        const response = await fetch(`/api/delete-api-key/${keyId}`, {
            method: 'DELETE'
        });

        if (response.ok) {
            location.reload();
        } else {
            const result = await response.json();
            showError('Failed to delete API key: ' + result.error);
            btn.innerHTML = originalHtml;
            btn.disabled = false;
        }
    } catch (error) {
        showError('Error deleting API key: ' + error.message);
        btn.innerHTML = originalHtml;
        btn.disabled = false;
    }
}

async function toggleApiKey(keyId) {
    const btn = event.target.closest('button');
    const originalHtml = btn.innerHTML;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
    btn.disabled = true;

    try {
        const response = await fetch(`/api/toggle-api-key/${keyId}`, {
            method: 'POST'
        });

        if (response.ok) {
            location.reload();
        } else {
            const result = await response.json();
            showError('Failed to toggle API key: ' + result.error);
            btn.innerHTML = originalHtml;
            btn.disabled = false;
        }
    } catch (error) {
        showError('Error toggling API key: ' + error.message);
        btn.innerHTML = originalHtml;
        btn.disabled = false;
    }
}
</script>
{% endblock %}
