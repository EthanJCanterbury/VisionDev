{% extends "base.html" %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
    <div class="mb-8 flex items-center justify-between">
        <div>
            <h1 class="text-3xl font-bold text-gray-900">
                <i class="fas fa-tasks mr-2 text-blue-500"></i>
                Review Jobs
            </h1>
            <p class="mt-2 text-sm text-gray-600">Monitor running and completed review jobs</p>
        </div>
        <button onclick="refreshJobs()"
                class="px-4 py-2 bg-blue-600 text-white font-medium rounded-lg hover:bg-blue-700 transition-all">
            <i class="fas fa-sync-alt mr-2"></i>
            Refresh
        </button>
    </div>

    <!-- Running Jobs -->
    <div class="bg-white rounded-lg shadow-md overflow-hidden mb-8">
        <div class="px-6 py-4 bg-blue-50 border-b border-blue-200">
            <h2 class="text-xl font-semibold text-gray-900 flex items-center">
                <i class="fas fa-spinner fa-spin mr-2 text-blue-500"></i>
                Running Jobs
                <span id="runningCount" class="ml-3 px-2 py-1 bg-blue-500 text-white text-xs rounded-full">0</span>
            </h2>
        </div>
        <div id="runningJobs" class="divide-y divide-gray-200">
            <div class="p-8 text-center text-gray-500">
                <i class="fas fa-inbox text-4xl mb-3"></i>
                <p>No jobs currently running</p>
            </div>
        </div>
    </div>

    <!-- Completed Jobs -->
    <div class="bg-white rounded-lg shadow-md overflow-hidden">
        <div class="px-6 py-4 bg-green-50 border-b border-green-200">
            <h2 class="text-xl font-semibold text-gray-900 flex items-center">
                <i class="fas fa-check-circle mr-2 text-green-500"></i>
                Recent Jobs
                <span id="historyCount" class="ml-3 px-2 py-1 bg-green-500 text-white text-xs rounded-full">0</span>
            </h2>
        </div>
        <div id="jobHistory" class="divide-y divide-gray-200">
            <div class="p-8 text-center text-gray-500">
                <i class="fas fa-inbox text-4xl mb-3"></i>
                <p>No completed jobs yet</p>
            </div>
        </div>
    </div>
</div>

<!-- Job Details Modal -->
<div id="jobDetailsModal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50">
    <div class="bg-white rounded-2xl p-6 max-w-4xl w-full mx-4 shadow-2xl transform transition-all max-h-[90vh] overflow-y-auto">
        <div class="flex items-center justify-between mb-6">
            <h3 class="text-2xl font-bold text-gray-900">
                <i class="fas fa-clipboard-list mr-2 text-blue-600"></i>
                Job Details
            </h3>
            <button onclick="closeJobDetails()" class="text-gray-400 hover:text-gray-600">
                <i class="fas fa-times text-2xl"></i>
            </button>
        </div>

        <div id="jobDetailsContent"></div>
    </div>
</div>

<!-- Console Logs Modal -->
<div id="consoleLogsModal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50">
    <div class="bg-white rounded-2xl p-6 max-w-4xl w-full mx-4 shadow-2xl transform transition-all max-h-[90vh] overflow-y-auto">
        <div class="flex items-center justify-between mb-6">
            <h3 class="text-2xl font-bold text-gray-900">
                <i class="fas fa-terminal mr-2 text-green-600"></i>
                Console Logs
            </h3>
            <button onclick="closeConsoleLogs()" class="text-gray-400 hover:text-gray-600">
                <i class="fas fa-times text-2xl"></i>
            </button>
        </div>

        <div id="consoleLogsContent"></div>
    </div>
</div>

<script>
let jobsData = { running: [], history: [] };

function getStatusIcon(status) {
    if (status === 'running') return '<i class="fas fa-spinner fa-spin text-blue-500 animate-pulse"></i>';
    if (status === 'completed') return '<i class="fas fa-check-circle text-green-500"></i>';
    if (status === 'failed') return '<i class="fas fa-times-circle text-red-500"></i>';
    if (status === 'cancelled') return '<i class="fas fa-ban text-orange-500"></i>';
    return '<i class="fas fa-clock text-gray-500"></i>';
}

function getStatusBadge(result) {
    if (!result || !result.status) return '';
    const status = result.status;
    if (status === 'Approved') return '<span class="px-2 py-1 bg-green-100 text-green-800 text-xs font-medium rounded-full">Approved</span>';
    if (status === 'Flagged') return '<span class="px-2 py-1 bg-yellow-100 text-yellow-800 text-xs font-medium rounded-full">Flagged</span>';
    if (status === 'Error') return '<span class="px-2 py-1 bg-red-100 text-red-800 text-xs font-medium rounded-full">Error</span>';
    return '';
}

async function updateJobs() {
    const response = await fetch('/api/jobs');
    const data = await response.json();
    jobsData = data;

    // Update running jobs
    const runningDiv = document.getElementById('runningJobs');
    const runningCount = document.getElementById('runningCount');
    runningCount.textContent = data.running.length;

    if (data.running.length === 0) {
        if (!runningDiv.querySelector('.text-center')) {
            runningDiv.innerHTML = `
                <div class="p-8 text-center text-gray-500">
                    <i class="fas fa-inbox text-4xl mb-3"></i>
                    <p>No jobs currently running</p>
                </div>
            `;
        }
    } else {
        // Remove "No jobs" message if it exists
        const emptyMessage = runningDiv.querySelector('.text-center');
        if (emptyMessage) {
            runningDiv.innerHTML = '';
        }

        // Smart update: only update current_step for existing jobs
        data.running.forEach(job => {
            const existingJob = runningDiv.querySelector(`[data-job-id="${job.id}"]`);
            if (existingJob) {
                // Just update the current step text
                const stepSpan = existingJob.querySelector('.job-current-step');
                if (stepSpan && stepSpan.textContent !== job.current_step) {
                    stepSpan.textContent = job.current_step;
                }
            } else {
                // New job, need to render it
                const jobHtml = `
                    <div class="p-6 hover:bg-gray-50 transition-all duration-300 border-l-4 border-blue-500 animate-fadeIn" data-job-id="${job.id}">
                        <div class="flex items-start justify-between">
                            <div class="flex-1">
                                <div class="flex items-center">
                                    ${getStatusIcon(job.status)}
                                    <h3 class="ml-3 text-lg font-medium text-gray-900">
                                        Job #${job.id}
                                    </h3>
                                    <span class="ml-3 px-2 py-1 bg-blue-100 text-blue-800 text-xs rounded-full animate-pulse">Live</span>
                                </div>
                                <div class="mt-2 space-y-1 text-sm text-gray-600">
                                    <p><i class="fas fa-database mr-2"></i>Base: <code class="bg-gray-100 px-2 py-1 rounded">${job.base_id}</code></p>
                                    <p><i class="fas fa-table mr-2"></i>Table: ${job.table_name}</p>
                                    <p><i class="fas fa-hashtag mr-2"></i>Record: ${job.record_id}</p>
                                </div>
                                <div class="mt-3 flex items-center gap-3">
                                    <div class="flex-1 bg-blue-50 border border-blue-200 rounded-lg px-4 py-2">
                                        <div class="flex items-center text-blue-700">
                                            <i class="fas fa-arrow-right mr-2 animate-bounce"></i>
                                            <span class="font-medium job-current-step">${job.current_step}</span>
                                        </div>
                                    </div>
                                    <button onclick="inspectJob(${job.id})"
                                            class="px-4 py-2 bg-purple-600 text-white font-medium rounded-lg hover:bg-purple-700 transition-all flex items-center gap-2">
                                        <i class="fas fa-search"></i>
                                        Inspect
                                    </button>
                                    <button onclick="cancelJob(${job.id})"
                                            class="px-4 py-2 bg-red-600 text-white font-medium rounded-lg hover:bg-red-700 transition-all flex items-center gap-2">
                                        <i class="fas fa-stop"></i>
                                        Cancel
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                runningDiv.insertAdjacentHTML('beforeend', jobHtml);
            }
        });

        // Remove jobs that are no longer running
        const currentJobIds = data.running.map(j => j.id);
        runningDiv.querySelectorAll('[data-job-id]').forEach(jobEl => {
            const jobId = parseInt(jobEl.dataset.jobId);
            if (!currentJobIds.includes(jobId)) {
                jobEl.remove();
            }
        });
    }

    // Update job history - only if count changed
    const historyDiv = document.getElementById('jobHistory');
    const historyCount = document.getElementById('historyCount');
    const oldHistoryCount = parseInt(historyCount.textContent);

    if (oldHistoryCount !== data.history.length) {
        historyCount.textContent = data.history.length;

        if (data.history.length === 0) {
            historyDiv.innerHTML = `
                <div class="p-8 text-center text-gray-500">
                    <i class="fas fa-inbox text-4xl mb-3"></i>
                    <p>No completed jobs yet</p>
                </div>
            `;
        } else {
            historyDiv.innerHTML = data.history.map(job => `
                <div class="p-6 hover:bg-gray-50">
                    <div class="flex items-start justify-between">
                        <div class="flex-1">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center">
                                    ${getStatusIcon(job.status)}
                                    <h3 class="ml-3 text-lg font-medium text-gray-900">
                                        Job #${job.id}
                                    </h3>
                                </div>
                                ${getStatusBadge(job.result)}
                            </div>
                            <div class="mt-2 space-y-1 text-sm text-gray-600">
                                <p><i class="fas fa-database mr-2"></i>Base: <code class="bg-gray-100 px-2 py-1 rounded">${job.base_id}</code></p>
                                <p><i class="fas fa-table mr-2"></i>Table: ${job.table_name}</p>
                                <p><i class="fas fa-hashtag mr-2"></i>Record: ${job.record_id}</p>
                            </div>
                            <div class="mt-3 flex gap-2">
                                <button onclick="showJobDetails(${job.id})"
                                        class="text-sm px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-all">
                                    <i class="fas fa-eye mr-2"></i>
                                    View Full Details
                                </button>
                                <button onclick="viewConsoleLogs(${job.id})"
                                        class="text-sm px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-all">
                                    <i class="fas fa-terminal mr-2"></i>
                                    View Logs
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }
    }
}

// Load jobs on page load
updateJobs();

// Auto-refresh every 1.5 seconds for faster updates
let autoRefreshInterval = setInterval(() => {
    updateJobs();
}, 1500);

// Stop auto-refresh when page is hidden
document.addEventListener('visibilitychange', () => {
    if (document.hidden) {
        clearInterval(autoRefreshInterval);
    } else {
        updateJobs();
        autoRefreshInterval = setInterval(() => {
            updateJobs();
        }, 1500);
    }
});

// Manual refresh function
function refreshJobs() {
    const btn = event.target.closest('button');
    const icon = btn.querySelector('i');
    icon.classList.add('fa-spin');

    updateJobs().then(() => {
        setTimeout(() => {
            icon.classList.remove('fa-spin');
        }, 500);
    });
}

// Format step results with detailed AI thinking
function formatStepResult(result, stepName) {
    let html = '';

    // Handle different step types with rich formatting
    if (stepName.includes('Duplicate')) {
        html += `<div class="text-sm"><strong>Duplicate Check:</strong> ${result.is_duplicate ? '<span class="text-red-600">Yes - Already submitted</span>' : '<span class="text-green-600">No - Original submission</span>'}</div>`;
    }

    if (stepName.includes('Test Project')) {
        html += `
            <div class="space-y-2 text-sm">
                <div><strong>Working:</strong> <span class="${result.is_working ? 'text-green-600' : 'text-red-600'}">${result.is_working ? 'Yes ✓' : 'No ✗'}</span></div>
                <div><strong>Legitimate:</strong> <span class="${result.is_legitimate ? 'text-green-600' : 'text-red-600'}">${result.is_legitimate ? 'Yes ✓' : 'No ✗'}</span></div>
                ${result.quality_score ? `<div><strong>Quality Score:</strong> ${result.quality_score}/10</div>` : ''}
                ${result.originality_score ? `<div><strong>Originality Score:</strong> ${result.originality_score}/10</div>` : ''}
                ${result.features && result.features.length > 0 ? `<div><strong>Features Detected:</strong> ${result.features.join(', ')}</div>` : ''}
                ${result.red_flags && result.red_flags.length > 0 ? `<div class="text-red-600"><strong>Red Flags:</strong> ${result.red_flags.join(', ')}</div>` : ''}
                ${result.assessment ? `
                    <div class="mt-2 p-2 bg-blue-50 border border-blue-200 rounded">
                        <strong class="text-blue-900">Auto Assessment:</strong>
                        <p class="text-gray-700 mt-1">${result.assessment}</p>
                    </div>
                ` : ''}
                ${result.technical_details ? `
                    <details class="mt-2">
                        <summary class="text-xs text-gray-600 cursor-pointer">Technical Details</summary>
                        <pre class="mt-1 text-xs bg-gray-100 p-2 rounded overflow-x-auto">${JSON.stringify(result.technical_details, null, 2)}</pre>
                    </details>
                ` : ''}
            </div>
        `;
    }

    if (stepName.includes('Commit')) {
        html += `
            <div class="space-y-2 text-sm">
                <div><strong>Matches Hours:</strong> <span class="${result.commits_match_hours ? 'text-green-600' : 'text-red-600'}">${result.commits_match_hours ? 'Yes ✓' : 'No ✗'}</span></div>
                <div><strong>Commit Pattern:</strong> <span class="px-2 py-1 bg-gray-200 rounded">${result.commit_pattern || 'N/A'}</span></div>
                ${result.commit_quality_score ? `<div><strong>Commit Quality:</strong> ${result.commit_quality_score}/10</div>` : ''}
                ${result.estimated_actual_hours ? `<div><strong>Estimated Hours:</strong> ${result.estimated_actual_hours}</div>` : ''}
                ${result.code_volume_appropriate !== undefined ? `<div><strong>Code Volume:</strong> ${result.code_volume_appropriate ? 'Appropriate ✓' : 'Suspicious ✗'}</div>` : ''}
                ${result.red_flags && result.red_flags.length > 0 ? `<div class="text-red-600"><strong>Red Flags:</strong> ${result.red_flags.join(', ')}</div>` : ''}
                ${result.assessment ? `
                    <div class="mt-2 p-2 bg-blue-50 border border-blue-200 rounded">
                        <strong class="text-blue-900">Auto Assessment:</strong>
                        <p class="text-gray-700 mt-1">${result.assessment}</p>
                    </div>
                ` : ''}
                ${result.metadata ? `
                    <details class="mt-2">
                        <summary class="text-xs text-gray-600 cursor-pointer">Commit Metadata</summary>
                        <div class="mt-1 text-xs space-y-1">
                            <div>Total Commits: ${result.metadata.total_commits || 0}</div>
                            <div>Time Span: ${result.metadata.time_span_days || 0} days</div>
                            <div>Code Changes: +${result.metadata.total_additions || 0} -${result.metadata.total_deletions || 0}</div>
                            <div>Authors: ${result.metadata.total_authors || 0}</div>
                        </div>
                    </details>
                ` : ''}
            </div>
        `;
    }

    if (stepName.includes('Final Decision')) {
        const statusColors = {
            'Approved': 'green',
            'Flagged': 'yellow',
            'Error': 'red'
        };
        const color = statusColors[result.status] || 'gray';

        html += `
            <div class="space-y-2 text-sm">
                <div><strong>Decision:</strong> <span class="px-3 py-1 bg-${color}-100 text-${color}-800 font-bold rounded">${result.status}</span></div>
                ${result.confidence_score ? `<div><strong>Confidence:</strong> ${result.confidence_score}/10</div>` : ''}
                ${result.review_notes ? `
                    <div class="mt-2 p-3 bg-purple-50 border border-purple-200 rounded">
                        <strong class="text-purple-900"><i class="fas fa-clipboard-check mr-1"></i> Review Notes (Internal):</strong>
                        <p class="text-gray-700 mt-1 whitespace-pre-wrap">${result.review_notes}</p>
                    </div>
                ` : ''}
                ${result.user_feedback ? `
                    <div class="mt-2 p-3 bg-blue-50 border border-blue-200 rounded">
                        <strong class="text-blue-900"><i class="fas fa-comment mr-1"></i> User Feedback:</strong>
                        <p class="text-gray-700 mt-1 whitespace-pre-wrap">${result.user_feedback}</p>
                    </div>
                ` : ''}
            </div>
        `;
    }

    // Fallback: show raw JSON if no special formatting
    if (!html) {
        html = `<pre class="text-xs bg-gray-100 p-2 rounded overflow-x-auto">${JSON.stringify(result, null, 2)}</pre>`;
    }

    return html;
}

// Inspect running job
function inspectJob(jobId) {
    // Find the job in running jobs by ID
    const jobData = jobsData.running.find(job => job.id === jobId);

    if (!jobData) {
        console.error('Running job not found:', jobId);
        return;
    }

    const modal = document.getElementById('jobDetailsModal');
    const content = document.getElementById('jobDetailsContent');

    content.innerHTML = `
        <div class="space-y-6">
            <!-- Live Console Window -->
            <div class="bg-black rounded-lg p-4 border border-gray-700 shadow-xl">
                <div class="flex items-center justify-between mb-3">
                    <h4 class="font-bold text-green-400 font-mono flex items-center">
                        <i class="fas fa-terminal mr-2"></i>
                        Live Console - Job #${jobData.id}
                    </h4>
                    <div class="flex items-center gap-2">
                        <span class="px-2 py-1 bg-green-500 text-black text-xs font-bold rounded animate-pulse">● LIVE</span>
                        <button onclick="refreshJobInspection(${jobData.id})" class="px-2 py-1 bg-gray-700 hover:bg-gray-600 text-white text-xs rounded">
                            <i class="fas fa-sync-alt"></i>
                        </button>
                    </div>
                </div>
                <div id="consoleOutput" class="bg-gray-900 rounded p-3 font-mono text-xs overflow-y-auto max-h-96 space-y-1">
                    ${jobData.console_log && jobData.console_log.length > 0 ? jobData.console_log.map(log => {
                        const time = new Date(log.timestamp).toLocaleTimeString();
                        let color = 'text-gray-300';
                        if (log.level === 'error') color = 'text-red-400';
                        else if (log.level === 'warning') color = 'text-yellow-400';
                        else if (log.level === 'success') color = 'text-green-400';

                        return `<div class="${color}"><span class="text-gray-500">[${time}]</span> ${log.message}</div>`;
                    }).join('') : '<div class="text-gray-500">Waiting for logs...</div>'}
                </div>
                <div class="mt-2 text-xs text-gray-500 font-mono flex items-center justify-between">
                    <span>
                        <i class="fas fa-info-circle mr-1"></i>
                        Auto-refresh: 500ms • ${jobData.console_log ? jobData.console_log.length : 0} log entries
                    </span>
                    <span class="text-green-400 animate-pulse">● LIVE</span>
                </div>
            </div>

            <!-- Job Info -->
            <div class="bg-purple-50 rounded-lg p-4 border border-purple-200">
                <h4 class="font-semibold text-gray-900 mb-3 flex items-center">
                    <i class="fas fa-search mr-2 text-purple-600"></i>
                    Job Information
                </h4>
                <div class="grid grid-cols-2 gap-4 text-sm">
                    <div>
                        <span class="text-gray-600">Job ID:</span>
                        <span class="ml-2 font-mono">#${jobData.id}</span>
                    </div>
                    <div>
                        <span class="text-gray-600">Status:</span>
                        <span class="ml-2 px-2 py-1 bg-blue-100 text-blue-800 text-xs rounded-full animate-pulse">Running</span>
                    </div>
                    <div>
                        <span class="text-gray-600">Base ID:</span>
                        <code class="ml-2 bg-gray-100 px-2 py-1 rounded">${jobData.base_id}</code>
                    </div>
                    <div>
                        <span class="text-gray-600">Table:</span>
                        <span class="ml-2">${jobData.table_name}</span>
                    </div>
                    <div class="col-span-2">
                        <span class="text-gray-600">Record ID:</span>
                        <code class="ml-2 bg-gray-100 px-2 py-1 rounded">${jobData.record_id}</code>
                    </div>
                </div>
            </div>

            <!-- Current Step -->
            <div class="bg-blue-50 rounded-lg p-4 border border-blue-200">
                <h4 class="font-semibold text-gray-900 mb-3 flex items-center">
                    <i class="fas fa-arrow-right mr-2 text-blue-600 animate-bounce"></i>
                    Current Step
                </h4>
                <p class="text-blue-700 font-medium">${jobData.current_step}</p>
            </div>

            <!-- Processing Steps (So Far) -->
            ${jobData.details ? `
                <div class="bg-green-50 rounded-lg p-4 border border-green-200">
                    <h4 class="font-semibold text-gray-900 mb-3 flex items-center">
                        <i class="fas fa-list-check mr-2 text-green-600"></i>
                        Completed Steps
                    </h4>
                    <div class="space-y-3">
                        ${jobData.details.steps && jobData.details.steps.length > 0 ? jobData.details.steps.map((step, index) => `
                            <div class="bg-white rounded-lg p-3 border border-gray-200">
                                <div class="flex items-start">
                                    <span class="flex-shrink-0 w-6 h-6 bg-green-600 text-white rounded-full flex items-center justify-center text-xs font-bold mr-3">
                                        <i class="fas fa-check"></i>
                                    </span>
                                    <div class="flex-1">
                                        <p class="font-medium text-gray-900">${step.name}</p>
                                        <p class="text-sm text-gray-600 mt-1"><strong>Status:</strong> ${step.status}</p>
                                        ${step.error ? `
                                            <div class="mt-2 p-2 bg-red-50 border border-red-200 rounded">
                                                <p class="text-sm text-red-700"><i class="fas fa-exclamation-triangle mr-1"></i> <strong>Error:</strong> ${step.error}</p>
                                            </div>
                                        ` : ''}
                                        ${step.result ? `
                                            <div class="mt-3">
                                                <details open class="bg-gray-50 rounded-lg overflow-hidden">
                                                    <summary class="text-sm font-semibold text-gray-700 bg-gray-100 px-3 py-2 cursor-pointer hover:bg-gray-200 border-b border-gray-300">
                                                        <i class="fas fa-brain mr-2"></i>Auto Analysis & Results
                                                    </summary>
                                                    <div class="p-3 space-y-2">
                                                        ${formatStepResult(step.result, step.name)}
                                                    </div>
                                                </details>
                                            </div>
                                        ` : ''}
                                    </div>
                                </div>
                            </div>
                        `).join('') : '<p class="text-gray-500 text-sm">No steps completed yet</p>'}
                    </div>
                </div>
            ` : '<p class="text-gray-500">No step details available yet</p>'}

            <div class="flex gap-3">
                <button onclick="closeJobDetails()" class="flex-1 px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700">
                    Close
                </button>
                <button onclick="refreshJobInspection(${jobData.id})" class="flex-1 px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700">
                    <i class="fas fa-sync-alt mr-2"></i>
                    Refresh
                </button>
            </div>
        </div>
    `;

    modal.classList.remove('hidden');

    // Start auto-refresh for this job
    startInspectAutoRefresh(jobId);

    // Auto-scroll console to bottom initially
    setTimeout(() => {
        const consoleOutput = document.getElementById('consoleOutput');
        if (consoleOutput) {
            consoleOutput.scrollTop = consoleOutput.scrollHeight;
        }
    }, 100);
}

let inspectRefreshInterval = null;
let currentInspectedJobId = null;

async function refreshJobInspection(jobId) {
    // Fetch the specific job directly instead of relying on global jobsData
    try {
        const response = await fetch(`/api/job/${jobId}`);
        const jobData = await response.json();

        // Only update the console if this is still the job being inspected
        if (currentInspectedJobId !== jobId) {
            return;
        }

        // Update just the console output without re-rendering the entire modal
        const consoleOutput = document.getElementById('consoleOutput');
        if (consoleOutput && jobData.console_log) {
            consoleOutput.innerHTML = jobData.console_log.length > 0 ? jobData.console_log.map(log => {
                const time = new Date(log.timestamp).toLocaleTimeString();
                let color = 'text-gray-300';
                if (log.level === 'error') color = 'text-red-400';
                else if (log.level === 'warning') color = 'text-yellow-400';
                else if (log.level === 'success') color = 'text-green-400';

                return `<div class="${color}"><span class="text-gray-500">[${time}]</span> ${log.message}</div>`;
            }).join('') : '<div class="text-gray-500">Waiting for logs...</div>';

            // Auto-scroll to bottom
            consoleOutput.scrollTop = consoleOutput.scrollHeight;
        }

        // Update log count
        const logCount = document.querySelector('#consoleOutput').previousElementSibling;
        if (logCount && jobData.console_log) {
            const countText = logCount.querySelector('span');
            if (countText) {
                countText.innerHTML = `<i class="fas fa-info-circle mr-1"></i>Auto-refresh: 500ms • ${jobData.console_log.length} log entries`;
            }
        }

        // Check if job completed - if so, stop auto-refresh and update global data
        if (jobData.status !== 'running') {
            stopInspectAutoRefresh();
            await updateJobs(); // Refresh the main jobs list
        }
    } catch (error) {
        console.error('Error refreshing job inspection:', error);
    }
}

function startInspectAutoRefresh(jobId) {
    // Stop any existing interval
    if (inspectRefreshInterval) {
        clearInterval(inspectRefreshInterval);
    }

    // Set the current inspected job
    currentInspectedJobId = jobId;

    // Refresh every 500ms while inspect modal is open
    inspectRefreshInterval = setInterval(() => {
        refreshJobInspection(jobId);
    }, 500);
}

function stopInspectAutoRefresh() {
    if (inspectRefreshInterval) {
        clearInterval(inspectRefreshInterval);
        inspectRefreshInterval = null;
    }
    currentInspectedJobId = null;
}

// Job details modal functions
function showJobDetails(jobId) {
    // Find the job in history by ID
    const jobData = jobsData.history.find(job => job.id === jobId);

    if (!jobData) {
        console.error('Job not found:', jobId);
        return;
    }

    const modal = document.getElementById('jobDetailsModal');
    const content = document.getElementById('jobDetailsContent');

    content.innerHTML = `
        <div class="space-y-6">
            <!-- Job Info -->
            <div class="bg-gray-50 rounded-lg p-4 border border-gray-200">
                <h4 class="font-semibold text-gray-900 mb-3 flex items-center">
                    <i class="fas fa-info-circle mr-2 text-blue-600"></i>
                    Job Information
                </h4>
                <div class="grid grid-cols-2 gap-4 text-sm">
                    <div>
                        <span class="text-gray-600">Job ID:</span>
                        <span class="ml-2 font-mono">#${jobData.id}</span>
                    </div>
                    <div>
                        <span class="text-gray-600">Status:</span>
                        <span class="ml-2">${getStatusBadge(jobData.result)}</span>
                    </div>
                    <div>
                        <span class="text-gray-600">Base ID:</span>
                        <code class="ml-2 bg-gray-100 px-2 py-1 rounded">${jobData.base_id}</code>
                    </div>
                    <div>
                        <span class="text-gray-600">Table:</span>
                        <span class="ml-2">${jobData.table_name}</span>
                    </div>
                    <div class="col-span-2">
                        <span class="text-gray-600">Record ID:</span>
                        <code class="ml-2 bg-gray-100 px-2 py-1 rounded">${jobData.record_id}</code>
                    </div>
                </div>
            </div>

            <!-- Processing Steps -->
            ${jobData.details ? `
                <div class="bg-blue-50 rounded-lg p-4 border border-blue-200">
                    <h4 class="font-semibold text-gray-900 mb-3 flex items-center">
                        <i class="fas fa-list-ol mr-2 text-blue-600"></i>
                        Review Steps
                    </h4>
                    <div class="space-y-3">
                        ${jobData.details.steps ? jobData.details.steps.map((step, index) => `
                            <div class="bg-white rounded-lg p-3 border border-gray-200">
                                <div class="flex items-start">
                                    <span class="flex-shrink-0 w-6 h-6 bg-blue-600 text-white rounded-full flex items-center justify-center text-xs font-bold mr-3">
                                        ${index + 1}
                                    </span>
                                    <div class="flex-1">
                                        <p class="font-medium text-gray-900">${step.name}</p>
                                        <p class="text-sm text-gray-600 mt-1"><strong>Status:</strong> ${step.status}</p>
                                        ${step.error ? `
                                            <div class="mt-2 p-2 bg-red-50 border border-red-200 rounded">
                                                <p class="text-sm text-red-700">
                                                    <i class="fas fa-exclamation-circle mr-1"></i>
                                                    <strong>Error:</strong> ${step.error}
                                                </p>
                                            </div>
                                        ` : ''}
                                        ${step.result ? `
                                            <div class="mt-3">
                                                <details open class="bg-gray-50 rounded-lg overflow-hidden">
                                                    <summary class="text-sm font-semibold text-gray-700 bg-gray-100 px-3 py-2 cursor-pointer hover:bg-gray-200 border-b border-gray-300">
                                                        <i class="fas fa-brain mr-2"></i>Auto Analysis & Results
                                                    </summary>
                                                    <div class="p-3 space-y-2">
                                                        ${formatStepResult(step.result, step.name)}
                                                    </div>
                                                </details>
                                            </div>
                                        ` : ''}
                                    </div>
                                </div>
                            </div>
                        `).join('') : '<p class="text-gray-500 text-sm">No detailed steps available</p>'}
                    </div>
                </div>
            ` : ''}

            <!-- Final Result -->
            ${jobData.result ? `
                <div class="bg-${jobData.status === 'completed' ? 'green' : 'red'}-50 rounded-lg p-4 border border-${jobData.status === 'completed' ? 'green' : 'red'}-200">
                    <h4 class="font-semibold text-gray-900 mb-3 flex items-center">
                        <i class="fas fa-${jobData.status === 'completed' ? 'check-circle' : 'exclamation-circle'} mr-2 text-${jobData.status === 'completed' ? 'green' : 'red'}-600"></i>
                        Final Result
                    </h4>
                    <div class="space-y-2 text-sm">
                        ${jobData.result.status ? `
                            <div>
                                <span class="text-gray-700 font-medium">Decision:</span>
                                <span class="ml-2">${getStatusBadge(jobData.result)}</span>
                            </div>
                        ` : ''}
                        ${jobData.result.review_notes ? `
                            <div>
                                <span class="text-gray-700 font-medium">Review Notes:</span>
                                <p class="mt-1 text-gray-600 whitespace-pre-wrap">${jobData.result.review_notes}</p>
                            </div>
                        ` : ''}
                        ${jobData.result.user_feedback ? `
                            <div>
                                <span class="text-gray-700 font-medium">User Feedback:</span>
                                <p class="mt-1 text-gray-600 whitespace-pre-wrap">${jobData.result.user_feedback}</p>
                            </div>
                        ` : ''}
                        ${jobData.result.error ? `
                            <div>
                                <span class="text-red-700 font-medium">Error:</span>
                                <p class="mt-1 text-red-600">${jobData.result.error}</p>
                            </div>
                        ` : ''}
                    </div>
                </div>
            ` : '<p class="text-gray-500">No result data available yet</p>'}
        </div>
    `;

    modal.classList.remove('hidden');
}

function closeJobDetails() {
    document.getElementById('jobDetailsModal').classList.add('hidden');
    // Stop auto-refresh when modal is closed
    stopInspectAutoRefresh();
}

async function cancelJob(jobId) {
    const btn = event.target.closest('button');
    const originalHtml = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Cancelling...';

    try {
        const response = await fetch(`/api/cancel-job/${jobId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });

        const result = await response.json();

        if (response.ok) {
            // Refresh jobs immediately
            await updateJobs();
        } else {
            // Show error in button temporarily
            btn.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Failed';
            btn.classList.add('bg-red-800');
            setTimeout(() => {
                btn.innerHTML = originalHtml;
                btn.disabled = false;
                btn.classList.remove('bg-red-800');
            }, 2000);
        }
    } catch (error) {
        // Show error in button temporarily
        btn.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Error';
        btn.classList.add('bg-red-800');
        setTimeout(() => {
            btn.innerHTML = originalHtml;
            btn.disabled = false;
            btn.classList.remove('bg-red-800');
        }, 2000);
    }
}

// View console logs for a completed job
async function viewConsoleLogs(jobId) {
    try {
        const response = await fetch(`/api/job/${jobId}`);
        const job = await response.json();

        const modal = document.getElementById('consoleLogsModal');
        const content = document.getElementById('consoleLogsContent');

        const logs = job.console_log || [];

        content.innerHTML = `
            <div class="bg-black rounded-lg p-4 border border-gray-700 shadow-xl">
                <div class="flex items-center justify-between mb-3">
                    <h4 class="font-bold text-green-400 font-mono flex items-center">
                        <i class="fas fa-terminal mr-2"></i>
                        Console Logs - Job #${job.id}
                    </h4>
                    <button onclick="downloadLogs(${job.id})" class="px-3 py-1 bg-blue-600 hover:bg-blue-700 text-white text-xs rounded">
                        <i class="fas fa-download mr-1"></i>
                        Download Logs
                    </button>
                </div>
                <div class="bg-gray-900 rounded p-3 font-mono text-xs overflow-y-auto max-h-96 space-y-1">
                    ${logs.length > 0 ? logs.map(log => {
                        const time = new Date(log.timestamp).toLocaleTimeString();
                        let color = 'text-gray-300';
                        if (log.level === 'error') color = 'text-red-400';
                        else if (log.level === 'warning') color = 'text-yellow-400';
                        else if (log.level === 'success') color = 'text-green-400';

                        return `<div class="${color}"><span class="text-gray-500">[${time}]</span> ${log.message}</div>`;
                    }).join('') : '<div class="text-gray-500">No logs available</div>'}
                </div>
            </div>
        `;

        modal.classList.remove('hidden');
    } catch (error) {
        console.error('Error fetching logs:', error);
    }
}

function closeConsoleLogs() {
    document.getElementById('consoleLogsModal').classList.add('hidden');
}

async function downloadLogs(jobId) {
    try {
        const response = await fetch(`/api/job/${jobId}`);
        const job = await response.json();

        const logs = job.console_log || [];

        // Format logs as plain text
        let logText = `Console Logs - Job #${job.id}\n`;
        logText += `Base: ${job.base_id}\n`;
        logText += `Table: ${job.table_name}\n`;
        logText += `Record: ${job.record_id}\n`;
        logText += `Status: ${job.status}\n`;
        logText += `Created: ${new Date(job.created_at).toLocaleString()}\n`;
        logText += `Completed: ${job.completed_at ? new Date(job.completed_at).toLocaleString() : 'N/A'}\n`;
        logText += `\n${'='.repeat(80)}\n\n`;

        logs.forEach(log => {
            const time = new Date(log.timestamp).toLocaleTimeString();
            logText += `[${time}] [${log.level.toUpperCase()}] ${log.message}\n`;
        });

        // Create download
        const blob = new Blob([logText], { type: 'text/plain' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `job-${jobId}-logs.txt`;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);
    } catch (error) {
        console.error('Error downloading logs:', error);
    }
}
</script>

<style>
@keyframes fadeIn {
    from {
        opacity: 0;
        transform: translateY(-10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

@keyframes slideIn {
    from {
        transform: translateX(-20px);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}

.animate-fadeIn {
    animation: fadeIn 0.5s ease-out;
}

.animate-slideIn {
    animation: slideIn 0.3s ease-out;
}
</style>
{% endblock %}
